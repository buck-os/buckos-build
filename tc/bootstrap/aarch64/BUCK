"""
Bootstrap aarch64 cross-toolchain.

Builds a cross-compiler targeting aarch64-buckos-linux-gnu, reusing the
same source tarballs as the x86_64 stage 1 pipeline.

Build chain:
  Host GCC + host binutils
    -> cross-binutils-aarch64
    -> cross-linux-headers-aarch64  (ARCH=arm64)
    -> cross-gcc-aarch64-pass1      (C only, --without-headers)
    -> cross-glibc-aarch64          (full glibc for aarch64)
    -> cross-gcc-aarch64-pass2      (C + C++, libstdc++)
    -> cross-toolchain-aarch64      (filegroup of above)
"""

load("//defs:package.bzl", "package")

# ── Cross-binutils for aarch64 ──────────────────────────────────────

package(
    name = "cross-binutils-aarch64",
    build_rule = "binary",
    local_only = True,
    source = "//bootstrap/stage1:binutils-src",
    version = "2.45.1",
    description = "Cross binutils for aarch64 bootstrap toolchain",
    homepage = "https://www.gnu.org/software/binutils/",
    license = "GPL-3.0",
    pre_configure_cmds = ['''
find . -name 'config.cache' -delete 2>/dev/null || true
echo "Cleaned stale config.cache files"
'''],
    install_script = """# configure
BUCKOS_TARGET="aarch64-buckos-linux-gnu"
mkdir -p build && cd build
../configure \
    --prefix=/tools \
    --target=$BUCKOS_TARGET \
    --with-sysroot=/tools \
    --disable-nls \
    --disable-werror \
    --disable-gdb \
    --disable-gdbserver \
    --disable-sim \
    --disable-libdecnumber \
    --disable-readline \
    --enable-gprofng=no \
    --enable-default-hash-style=gnu \
    MAKEINFO=true

# build
# Build binutils and ld with full parallelism
make -j$MAKE_JOBS MAKEINFO=true all-binutils all-ld

# Build gas with reduced parallelism to avoid race condition with temp .s files
GAS_JOBS=$((MAKE_JOBS > 4 ? 4 : MAKE_JOBS))
make -j$GAS_JOBS MAKEINFO=true all-gas

# install
BUCKOS_TARGET="aarch64-buckos-linux-gnu"
make -j$MAKE_JOBS DESTDIR="$OUT" install-binutils install-gas install-ld MAKEINFO=true
make -j$MAKE_JOBS DESTDIR="$OUT" install-bfd install-libiberty install-libsframe MAKEINFO=true || true

# Create unprefixed symlinks in the standard cross-toolchain location
# GCC looks in <prefix>/<target>/bin/ for target tools (as, ld, etc.)
# This keeps them separate from tools/bin/ so they don't shadow host tools
mkdir -p "$OUT/tools/$BUCKOS_TARGET/bin"
cd "$OUT/tools/$BUCKOS_TARGET/bin"
for tool in as ld ar nm ranlib objcopy objdump strip readelf; do
    if [ -f "../../bin/${BUCKOS_TARGET}-${tool}" ] && [ ! -e "$tool" ]; then
        ln -sf "../../bin/${BUCKOS_TARGET}-${tool}" "$tool"
        echo "Created symlink in sysroot: $tool -> ../../bin/${BUCKOS_TARGET}-${tool}"
    fi
done""",
    visibility = ["PUBLIC"],
)

# ── ARM64 Linux Headers ─────────────────────────────────────────────

package(
    name = "cross-linux-headers-aarch64",
    build_rule = "binary",
    local_only = True,
    source = "//bootstrap/stage1:linux-src",
    version = "6.12.60",
    description = "Linux kernel headers for aarch64 bootstrap",
    homepage = "https://www.kernel.org/",
    license = "GPL-2.0",
    install_script = """# configure
# No configure needed for headers
true

# build
# No compilation needed
true

# install
BUCKOS_TARGET="aarch64-buckos-linux-gnu"
# Install to sysroot location for cross-compilation
HEADER_DEST="$OUT/tools/$BUCKOS_TARGET/include"
mkdir -p "$HEADER_DEST"

# Use ARCH=arm64 for aarch64 headers
make -j$MAKE_JOBS ARCH=arm64 INSTALL_HDR_PATH="$OUT/tools/$BUCKOS_TARGET" headers_install

# Also install to /tools/include for compatibility
mkdir -p "$OUT/tools/include"
cp -a "$HEADER_DEST"/* "$OUT/tools/include/" 2>/dev/null || true

echo "Installed ARM64 Linux headers to $HEADER_DEST"
""",
    visibility = ["PUBLIC"],
)

# ── ARM64 Cross GCC Pass 1 (C compiler only, no libc) ───────────────

package(
    name = "cross-gcc-aarch64-pass1",
    build_rule = "binary",
    local_only = True,
    source = "//bootstrap/stage1:gcc-src",
    version = "14.3.0",
    description = "Cross GCC pass 1 for aarch64 - C compiler only",
    homepage = "https://gcc.gnu.org/",
    license = "GPL-3.0",
    pre_configure_cmds = ['''
echo "Available dependency paths via DEP_BASE_DIRS:"
echo "$DEP_BASE_DIRS"

GMP_DIR=""
MPFR_DIR=""
MPC_DIR=""

IFS=':' read -ra DEPS <<< "$DEP_BASE_DIRS"
for dep_dir in "${DEPS[@]}"; do
    if [[ "$dep_dir" == *"gmp-src"* ]] && [[ -f "$dep_dir/configure.ac" ]]; then
        GMP_DIR="$dep_dir"
    elif [[ "$dep_dir" == *"mpfr-src"* ]] && [[ -f "$dep_dir/configure.ac" ]]; then
        MPFR_DIR="$dep_dir"
    elif [[ "$dep_dir" == *"mpc-src"* ]] && [[ -f "$dep_dir/configure.ac" ]]; then
        MPC_DIR="$dep_dir"
    fi
done

if [[ -n "$GMP_DIR" ]]; then
    ln -sfn "$GMP_DIR" gmp
    echo "Linked GMP from $GMP_DIR"
else
    echo "ERROR: Could not find GMP source directory" >&2
    exit 1
fi

if [[ -n "$MPFR_DIR" ]]; then
    ln -sfn "$MPFR_DIR" mpfr
    echo "Linked MPFR from $MPFR_DIR"
else
    echo "ERROR: Could not find MPFR source directory" >&2
    exit 1
fi

if [[ -n "$MPC_DIR" ]]; then
    ln -sfn "$MPC_DIR" mpc
    echo "Linked MPC from $MPC_DIR"
else
    echo "ERROR: Could not find MPC source directory" >&2
    exit 1
fi

echo "GCC source dependencies linked successfully"
ls -la gmp mpfr mpc

# Disable c++tools and libcody to avoid GCC C++26 configure compatibility issues
# These are not needed for cross-compiler bootstrap pass 1 (C only)
# We must patch Makefile.in BEFORE configure runs, so the generated Makefile is clean

echo "Patching Makefile.in to remove libcody and c++tools dependencies..."

# Remove libcody from host subdirs list (pattern: "libcody " with space)
sed -i 's|libcody ||g' Makefile.in || true
sed -i 's|c++tools ||g' Makefile.in || true

# CRITICAL: Remove all dependency lines where targets depend on libcody
# These are lines like "all-gcc: all-libcody" and "all-stage1-gcc: all-stage1-libcody"
# Delete any line that has ": all-libcody" or ": all-stage*-libcody" etc.
sed -i '/: all-libcody$/d' Makefile.in || true
sed -i '/: all-stage[0-9]*-libcody$/d' Makefile.in || true
sed -i '/: all-stage[a-z]*-libcody$/d' Makefile.in || true
sed -i '/: configure-libcody$/d' Makefile.in || true
sed -i '/: configure-stage[0-9]*-libcody$/d' Makefile.in || true
sed -i '/: maybe-all-libcody$/d' Makefile.in || true
sed -i '/: maybe-configure-libcody$/d' Makefile.in || true

# Also remove any remaining libcody references in dependency lists
# Pattern: remove "all-libcody" or "maybe-all-libcody" when they appear with other deps
sed -i 's/ all-libcody / /g' Makefile.in || true
sed -i 's/ all-libcody$//g' Makefile.in || true
sed -i 's/ maybe-all-libcody / /g' Makefile.in || true
sed -i 's/ maybe-all-libcody$//g' Makefile.in || true

echo "Makefile.in patched to remove libcody dependencies"

# Remove the libcody directory entirely to prevent GCC from trying to build it
if [ -d libcody ]; then
    echo "Removing libcody directory..."
    rm -rf libcody
    echo "libcody directory removed"
fi

# Also remove c++tools directory if present
if [ -d c++tools ]; then
    echo "Removing c++tools directory..."
    rm -rf c++tools
    echo "c++tools directory removed"
fi
'''],
    install_script = """export CC="gcc -std=gnu11 -Wno-error=implicit-function-declaration"
export CFLAGS="-O2 -std=gnu11 -Wno-error=implicit-function-declaration"
export CXX="g++ -std=gnu++11"
export CXXFLAGS="-O2 -std=gnu++11"
export CC_FOR_BUILD="gcc"
export CXX_FOR_BUILD="g++"
export AS_FOR_BUILD="/usr/bin/as"
export AR_FOR_BUILD="/usr/bin/ar"
export LD_FOR_BUILD="/usr/bin/ld"
export NM_FOR_BUILD="/usr/bin/nm"
export RANLIB_FOR_BUILD="/usr/bin/ranlib"

# configure
BUCKOS_TARGET="aarch64-buckos-linux-gnu"

# Find cross-binutils directory but DON'T add to PATH yet
# This prevents configure from picking up cross-tools for host builds
BINUTILS_DIR=""
IFS=':' read -ra DEPS <<< "$DEP_BASE_DIRS"
for dep_dir in "${DEPS[@]}"; do
    if [[ "$dep_dir" == *"cross-binutils-aarch64"* ]] && [[ -d "$dep_dir/tools/bin" ]]; then
        BINUTILS_DIR="$dep_dir/tools"
        break
    fi
done

if [[ -n "$BINUTILS_DIR" ]]; then
    echo "Found cross-binutils at: $BINUTILS_DIR"
    # Set explicit paths to cross-tools for configure
    CROSS_AS="$BINUTILS_DIR/bin/${BUCKOS_TARGET}-as"
    CROSS_LD="$BINUTILS_DIR/bin/${BUCKOS_TARGET}-ld"
    CROSS_AR="$BINUTILS_DIR/bin/${BUCKOS_TARGET}-ar"
    CROSS_NM="$BINUTILS_DIR/bin/${BUCKOS_TARGET}-nm"
    CROSS_RANLIB="$BINUTILS_DIR/bin/${BUCKOS_TARGET}-ranlib"
else
    echo "Warning: cross-binutils-aarch64 not found in dependencies"
fi

# Find linux-headers for libgcc build
LINUX_HEADERS_DIR=""
for dep_dir in "${DEPS[@]}"; do
    if [[ "$dep_dir" == *"linux-headers-aarch64"* ]] || [[ "$dep_dir" == *"cross-linux-headers-aarch64"* ]]; then
        if [[ -d "$dep_dir/tools/$BUCKOS_TARGET/include/linux" ]]; then
            LINUX_HEADERS_DIR="$dep_dir/tools/$BUCKOS_TARGET/include"
            echo "Found linux-headers at: $LINUX_HEADERS_DIR"
            break
        fi
    fi
done

if [[ -z "$LINUX_HEADERS_DIR" ]]; then
    echo "Warning: linux-headers not found, libgcc build may fail"
fi

mkdir -p build && cd build
../configure \
    --prefix=/tools \
    --target=$BUCKOS_TARGET \
    --with-sysroot=/tools \
    --with-newlib \
    --without-headers \
    --enable-initfini-array \
    --enable-languages=c \
    --disable-nls \
    --disable-shared \
    --disable-multilib \
    --disable-threads \
    --disable-libatomic \
    --disable-libgomp \
    --disable-libquadmath \
    --disable-libssp \
    --disable-libvtv \
    --disable-libstdcxx \
    --disable-c++tools \
    --disable-decimal-float \
    --disable-libgcov \
    --disable-fixincludes \
    --disable-bootstrap \
    --enable-default-hash-style=gnu \
    AS_FOR_TARGET="$CROSS_AS" \
    LD_FOR_TARGET="$CROSS_LD" \
    AR_FOR_TARGET="$CROSS_AR" \
    NM_FOR_TARGET="$CROSS_NM" \
    RANLIB_FOR_TARGET="$CROSS_RANLIB" \
    MAKEINFO=true

# build
BUCKOS_TARGET="aarch64-buckos-linux-gnu"

# Find cross-binutils directory but DON'T add to PATH yet!
# Adding cross-tools to PATH causes GCC's build system to use aarch64-as for host builds
BINUTILS_DIR=""
IFS=':' read -ra DEPS <<< "$DEP_BASE_DIRS"
for dep_dir in "${DEPS[@]}"; do
    if [[ "$dep_dir" == *"cross-binutils-aarch64"* ]] && [[ -d "$dep_dir/tools/bin" ]]; then
        BINUTILS_DIR="$dep_dir/tools"
        break
    fi
done

# GCC's build system can trigger configure during parallel make if subdirectories
# aren't pre-configured. Pre-configure the specific components we need.
echo "Pre-configuring GCC subdirectories..."
for subdir in libiberty zlib libcpp libdecnumber libbacktrace gmp mpfr mpc; do
    if [ -d "../$subdir" ] || [ -d "$subdir" ]; then
        echo "Pre-configuring $subdir..."
        make -j1 configure-$subdir 2>/dev/null || true
    fi
done

# Also configure build-side components
for subdir in build-libiberty build-libcpp; do
    make -j1 configure-$subdir 2>/dev/null || true
done

# Safety net: remove any remaining libcody references from generated Makefiles
echo "Removing any remaining libcody references from generated Makefiles..."
if [ -f Makefile ]; then
    sed -i '/: all-libcody$/d' Makefile || true
    sed -i '/: all-stage.*-libcody$/d' Makefile || true
    sed -i 's/ all-libcody / /g' Makefile || true
    sed -i 's/ all-libcody$//g' Makefile || true
fi

if [ -f gcc/Makefile ]; then
    sed -i '/libcody\.a/d' gcc/Makefile || true
    sed -i 's|\.\./libcody/[^ ]*||g' gcc/Makefile || true
fi

# Build with full parallelism - DO NOT add cross-binutils to PATH here!
# GCC configure already knows where the cross-tools are via AS_FOR_TARGET etc.
# Adding them to PATH causes host builds (genmodes, etc) to use wrong assembler
echo "Building GCC compiler with $MAKE_JOBS jobs..."
make -j$MAKE_JOBS MAKEINFO=true all-gcc

# Now add cross-binutils to PATH for target libgcc build
if [[ -n "$BINUTILS_DIR" ]]; then
    export PATH="$BINUTILS_DIR/bin:$PATH"
    echo "Added cross-binutils to PATH for libgcc: $BINUTILS_DIR/bin"
fi

# Build target libgcc - configure it first, then build just libgcc.a
# all-target-libgcc includes libgcov which needs glibc headers we don't have yet
echo "Configuring target libgcc..."
make configure-target-libgcc

echo "Building target libgcc.a (without libgcov)..."
cd "$BUCKOS_TARGET/libgcc"

# Build libgcc.a with inhibit_libc to avoid needing libc headers
# This builds a minimal libgcc that works for bootstrap
make -j$MAKE_JOBS libgcc.a INHIBIT_LIBC_CFLAGS="-Dinhibit_libc"

# Also build the CRT objects needed for shared library building
echo "Building CRT objects for shared library support..."
make -j$MAKE_JOBS crtbegin.o crtend.o crtbeginS.o crtendS.o crtbeginT.o 2>/dev/null || {
    echo "CRT objects not all built, trying alternative method..."
    make -j$MAKE_JOBS crt.o crtbegin.o crtend.o 2>/dev/null || true
}

# Verify libgcc.a was created
if [ ! -f libgcc.a ]; then
    echo "ERROR: libgcc.a was not built!"
    exit 1
fi
echo "Successfully built libgcc.a"

cd ../..

# install
BUCKOS_TARGET="aarch64-buckos-linux-gnu"

# Add cross-binutils to PATH for install (some GCC install scripts may need them)
IFS=':' read -ra DEPS <<< "$DEP_BASE_DIRS"
for dep_dir in "${DEPS[@]}"; do
    if [[ "$dep_dir" == *"cross-binutils-aarch64"* ]] && [[ -d "$dep_dir/tools/bin" ]]; then
        export PATH="$dep_dir/tools/bin:$PATH"
        echo "Added cross-binutils to PATH: $dep_dir/tools/bin"
        break
    fi
done

# For pass1, we only need to install the compiler and libgcc.a
echo "Installing GCC compiler..."
make -j$MAKE_JOBS DESTDIR="$OUT" install-gcc MAKEINFO=true 2>&1 | tee install.log

# Check if install created the bin directory
if [ ! -d "$OUT/tools/bin" ]; then
    echo "WARNING: install-gcc did not create bin directory!"
    echo "Contents of DESTDIR:"
    find "$OUT" -type f | head -20
    echo ""
    echo "Last 50 lines of install.log:"
    tail -50 install.log

    # Try to manually install gcc binaries if they exist
    echo "Attempting manual installation of gcc binaries..."
    mkdir -p "$OUT/tools/bin"
    if [ -f gcc/xgcc ]; then
        cp gcc/xgcc "$OUT/tools/bin/${BUCKOS_TARGET}-gcc"
        chmod +x "$OUT/tools/bin/${BUCKOS_TARGET}-gcc"
        echo "Manually installed xgcc as ${BUCKOS_TARGET}-gcc"
    fi
    if [ -f gcc/cpp ]; then
        cp gcc/cpp "$OUT/tools/bin/${BUCKOS_TARGET}-cpp"
        chmod +x "$OUT/tools/bin/${BUCKOS_TARGET}-cpp"
        echo "Manually installed cpp as ${BUCKOS_TARGET}-cpp"
    fi
fi

# Verify bin directory now exists
if [ ! -d "$OUT/tools/bin" ] || [ -z "$(ls -A $OUT/tools/bin 2>/dev/null)" ]; then
    echo "ERROR: bin directory still not populated after install!"
    exit 1
fi

echo "Contents of installed bin directory:"
ls -la "$OUT/tools/bin/"

# Manually install libgcc.a (we can't use install-target-libgcc as it tries to install libgcov)
GCC_VERSION=$(cat gcc/BASE-VER 2>/dev/null || echo "14.3.0")
LIBGCC_DIR="$OUT/tools/lib/gcc/$BUCKOS_TARGET/$GCC_VERSION"
mkdir -p "$LIBGCC_DIR"

if [ ! -f "$BUCKOS_TARGET/libgcc/libgcc.a" ]; then
    echo "ERROR: libgcc.a not found - build failed!"
    exit 1
fi

cp "$BUCKOS_TARGET/libgcc/libgcc.a" "$LIBGCC_DIR/"
echo "Installed libgcc.a to $LIBGCC_DIR/"

# Install CRT objects if they were built
for crt in crtbegin.o crtend.o crtbeginS.o crtendS.o crtbeginT.o; do
    if [ -f "$BUCKOS_TARGET/libgcc/$crt" ]; then
        cp "$BUCKOS_TARGET/libgcc/$crt" "$LIBGCC_DIR/"
        echo "Installed $crt"
    fi
done""",
    deps = [
        "//bootstrap/stage1:gmp-src",
        "//bootstrap/stage1:mpfr-src",
        "//bootstrap/stage1:mpc-src",
        ":cross-binutils-aarch64",
        ":cross-linux-headers-aarch64",
    ],
    visibility = ["PUBLIC"],
)

# ── ARM64 Cross glibc ───────────────────────────────────────────────

package(
    name = "cross-glibc-aarch64",
    build_rule = "binary",
    local_only = True,
    source = "//bootstrap/stage1:glibc-src",
    version = "2.42",
    description = "GNU C Library for aarch64 cross-compilation",
    homepage = "https://www.gnu.org/software/libc/",
    license = "LGPL-2.1",
    install_script = """export CC="aarch64-buckos-linux-gnu-gcc"
export CXX="aarch64-buckos-linux-gnu-g++"
export AR="aarch64-buckos-linux-gnu-ar"
export AS="aarch64-buckos-linux-gnu-as"
export LD="aarch64-buckos-linux-gnu-ld"
export NM="aarch64-buckos-linux-gnu-nm"
export RANLIB="aarch64-buckos-linux-gnu-ranlib"
export OBJCOPY="aarch64-buckos-linux-gnu-objcopy"
export OBJDUMP="aarch64-buckos-linux-gnu-objdump"
export STRIP="aarch64-buckos-linux-gnu-strip"

# configure
BUCKOS_TARGET="aarch64-buckos-linux-gnu"

# Setup PATH to find cross-compiler and cross-binutils
IFS=':' read -ra DEPS <<< "$DEP_BASE_DIRS"
BINUTILS_SYSROOT_BIN=""
for dep_dir in "${DEPS[@]}"; do
    if [[ -d "$dep_dir/tools/bin" ]]; then
        export PATH="$dep_dir/tools/bin:$PATH"
        # Remember binutils sysroot bin directory for -B flag
        # Unprefixed tools (as, ld) are in tools/<target>/bin/
        if [[ "$dep_dir" == *"cross-binutils-aarch64"* ]]; then
            BINUTILS_SYSROOT_BIN="$dep_dir/tools/$BUCKOS_TARGET/bin/"
        fi
    fi
done

echo "Cross-compiler location: $(which ${BUCKOS_TARGET}-gcc || echo 'not found')"
echo "Cross-assembler location: $(which ${BUCKOS_TARGET}-as || echo 'not found')"
echo "Binutils sysroot bin directory: $BINUTILS_SYSROOT_BIN"

# Use -B flag to tell GCC where to find the cross-binutils (as, ld, etc.)
# The unprefixed tools are in the sysroot bin directory
if [[ -n "$BINUTILS_SYSROOT_BIN" ]]; then
    export CC="${BUCKOS_TARGET}-gcc -B${BINUTILS_SYSROOT_BIN}"
    export CXX="${BUCKOS_TARGET}-g++ -B${BINUTILS_SYSROOT_BIN}"
else
    export CC="${BUCKOS_TARGET}-gcc"
    export CXX="${BUCKOS_TARGET}-g++"
fi

# Also set the other tools explicitly
export AS="${BUCKOS_TARGET}-as"
export LD="${BUCKOS_TARGET}-ld"
export AR="${BUCKOS_TARGET}-ar"
export NM="${BUCKOS_TARGET}-nm"
export RANLIB="${BUCKOS_TARGET}-ranlib"
export OBJCOPY="${BUCKOS_TARGET}-objcopy"
export OBJDUMP="${BUCKOS_TARGET}-objdump"
export STRIP="${BUCKOS_TARGET}-strip"

# Find kernel headers
KERNEL_HEADERS=""
for dep_dir in "${DEPS[@]}"; do
    if [[ "$dep_dir" == *"linux-headers-aarch64"* ]] || [[ "$dep_dir" == *"cross-linux-headers-aarch64"* ]]; then
        if [[ -d "$dep_dir/tools/$BUCKOS_TARGET/include/linux" ]]; then
            KERNEL_HEADERS="$dep_dir/tools/$BUCKOS_TARGET/include"
            break
        fi
    fi
done

if [[ -z "$KERNEL_HEADERS" ]]; then
    echo "Warning: Could not find ARM64 kernel headers"
fi

mkdir -p build && cd build

# CRITICAL: CPP must use the cross-compiler's preprocessor, not the host gcc
# glibc's configure uses CPP to check the compiler version requirement (>= GCC 12.1)
# Without this, it uses the host gcc (11.5.0) which fails the version check
CROSS_CPP="$CC -E"

# Configure with /usr prefix like x86_64 version - this ensures proper stubs.h generation
echo "rootsbindir=/usr/sbin" > configparms

../configure \
    --prefix=/usr \
    --host=$BUCKOS_TARGET \
    --build=$(../scripts/config.guess) \
    --with-headers="$KERNEL_HEADERS" \
    --enable-kernel=5.4 \
    --disable-werror \
    --disable-nscd \
    CC="$CC" \
    CPP="$CROSS_CPP" \
    LD="$LD" \
    AR="$AR" \
    AS="$AS" \
    NM="$NM" \
    RANLIB="$RANLIB" \
    OBJCOPY="$OBJCOPY" \
    OBJDUMP="$OBJDUMP" \
    STRIP="$STRIP" \
    libc_cv_slibdir=/usr/lib \
    libc_cv_forced_unwind=yes \
    libc_cv_c_cleanup=yes \
    libc_cv_pde=yes \
    libc_cv_cxx_link_ok=no \
    CXX=""

# build
BUCKOS_TARGET="aarch64-buckos-linux-gnu"

# Setup PATH to find cross-compiler and cross-binutils
IFS=':' read -ra DEPS <<< "$DEP_BASE_DIRS"
BINUTILS_SYSROOT_BIN=""
for dep_dir in "${DEPS[@]}"; do
    if [[ -d "$dep_dir/tools/bin" ]]; then
        export PATH="$dep_dir/tools/bin:$PATH"
        if [[ "$dep_dir" == *"cross-binutils-aarch64"* ]]; then
            BINUTILS_SYSROOT_BIN="$dep_dir/tools/$BUCKOS_TARGET/bin/"
        fi
    fi
done

if [[ -n "$BINUTILS_SYSROOT_BIN" ]]; then
    export CC="${BUCKOS_TARGET}-gcc -B${BINUTILS_SYSROOT_BIN}"
    export CPP="${BUCKOS_TARGET}-gcc -B${BINUTILS_SYSROOT_BIN} -E"
else
    export CC="${BUCKOS_TARGET}-gcc"
    export CPP="${BUCKOS_TARGET}-gcc -E"
fi

export AS="${BUCKOS_TARGET}-as"
export LD="${BUCKOS_TARGET}-ld"
export AR="${BUCKOS_TARGET}-ar"
export NM="${BUCKOS_TARGET}-nm"
export RANLIB="${BUCKOS_TARGET}-ranlib"

echo "Building glibc for aarch64..."
echo "CC=$CC"
echo "PATH=$PATH"

# Build with parallel jobs - glibc's Makefiles handle dependencies correctly
make -j$MAKE_JOBS || {
    echo "Full parallel build failed, trying with fewer jobs..."
    make -j4
}

# install
BUCKOS_TARGET="aarch64-buckos-linux-gnu"

# First install headers explicitly (glibc cross-compile may not install them with regular install)
echo "Installing glibc headers..."
make -j$MAKE_JOBS DESTDIR="$OUT" install-headers || echo "install-headers failed, continuing..."

# Then run full install (libraries, etc.)
echo "Installing glibc..."
make -j$MAKE_JOBS DESTDIR="$OUT" install || echo "install failed, will manually copy files..."

# Create a dummy stubs.h if it wasn't generated
if [ ! -f "$OUT/usr/include/gnu/stubs.h" ]; then
    echo "Creating stub gnu/stubs.h..."
    mkdir -p "$OUT/usr/include/gnu"
    cat > "$OUT/usr/include/gnu/stubs.h" << 'STUBSEOF'
/* This file is automatically generated.
   This file selects the right generated file of `__stub_FUNCTION' macros
   based on the architecture being compiled for.  */

#if defined __LP64__
# include <gnu/stubs-lp64.h>
#endif
STUBSEOF
    # Also create the stubs-lp64.h file
    touch "$OUT/usr/include/gnu/stubs-lp64.h"
fi

# Manually copy CRT files if they weren't installed
echo "Checking for CRT files..."
if [ ! -f "$OUT/usr/lib/crti.o" ]; then
    echo "Manually copying CRT files from build directory..."
    mkdir -p "$OUT/usr/lib"
    cp -v csu/crt1.o "$OUT/usr/lib/" 2>/dev/null || true
    cp -v csu/crti.o "$OUT/usr/lib/" 2>/dev/null || true
    cp -v csu/crtn.o "$OUT/usr/lib/" 2>/dev/null || true
    cp -v csu/Scrt1.o "$OUT/usr/lib/" 2>/dev/null || true
    cp -v csu/gcrt1.o "$OUT/usr/lib/" 2>/dev/null || true
fi

# Copy all shared libraries and archive files to /usr/lib
echo "Copying all glibc libraries..."
for dir in . elf nptl dlfcn io misc posix setjmp signal stdlib string time dirent grp pwd locale \
           ctype wctype math malloc debug resource login crypt intl inet resolv nss sunrpc nis \
           nscd hesiod timezone iconv iconvdata nptl_db argp sysvipc rt conform wcsmbs conform conform; do
    if [ -d "$dir" ]; then
        find "$dir" -maxdepth 1 -name "*.so*" -exec cp -v {} "$OUT/usr/lib/" \; 2>/dev/null || true
        find "$dir" -maxdepth 1 -name "*.a" -exec cp -v {} "$OUT/usr/lib/" \; 2>/dev/null || true
        find "$dir" -maxdepth 1 -name "*.o" -exec cp -v {} "$OUT/usr/lib/" \; 2>/dev/null || true
    fi
done

# Copy the dynamic linker
echo "Copying dynamic linker..."
if [ -f "elf/ld.so" ]; then
    cp -v elf/ld.so "$OUT/usr/lib/ld-linux-aarch64.so.1" 2>/dev/null || true
    cp -v elf/ld.so "$OUT/usr/lib/ld.so" 2>/dev/null || true
fi

# CRITICAL: Fix libc.so - it must be a linker script, not an ELF binary
# glibc's make install sometimes creates libc.so as the actual library
# We need to check if it's an ELF and fix it
echo "Checking and fixing libc.so..."
if [ -f "$OUT/usr/lib/libc.so" ]; then
    # Check if it's an ELF binary (not a linker script)
    if file "$OUT/usr/lib/libc.so" | grep -q "ELF"; then
        echo "libc.so is an ELF binary - fixing by creating linker script..."
        rm -f "$OUT/usr/lib/libc.so"
    fi
fi

# Create proper libc.so linker script
echo "Creating libc.so linker script..."
cat > "$OUT/usr/lib/libc.so" << 'LIBCEOF'
/* GNU ld script
   Use the shared library, but some functions are only in the static library. */
OUTPUT_FORMAT(elf64-littleaarch64)
GROUP ( libc.so.6 libc_nonshared.a AS_NEEDED ( ld-linux-aarch64.so.1 ) )
LIBCEOF

echo "Install completed, checking output structure:"
find "$OUT" -type d | head -20
echo "Library files in usr/lib:"
ls -la "$OUT/usr/lib/" 2>/dev/null | head -30

# Create the dynamic linker symlink for aarch64
mkdir -p "$OUT/lib"
if [ -f "$OUT/usr/lib/ld-linux-aarch64.so.1" ]; then
    ln -sf ../usr/lib/ld-linux-aarch64.so.1 "$OUT/lib/ld-linux-aarch64.so.1"
fi

# Also create /tools directory structure for compatibility with GCC pass2
mkdir -p "$OUT/tools/$BUCKOS_TARGET/lib"
mkdir -p "$OUT/tools/$BUCKOS_TARGET/include"

# Copy headers to tools sysroot structure for GCC pass2
if [ -d "$OUT/usr/include" ]; then
    echo "Copying headers to tools sysroot..."
    cp -a "$OUT/usr/include"/* "$OUT/tools/$BUCKOS_TARGET/include/" 2>/dev/null || true
    # Also copy to /tools/include for fallback
    mkdir -p "$OUT/tools/include"
    cp -a "$OUT/usr/include"/* "$OUT/tools/include/" 2>/dev/null || true
fi

# Copy libraries to tools sysroot structure for GCC pass2
if [ -d "$OUT/usr/lib" ]; then
    echo "Copying libraries to tools sysroot..."
    cp -a "$OUT/usr/lib"/* "$OUT/tools/$BUCKOS_TARGET/lib/" 2>/dev/null || true
    # Also copy to /tools/lib for fallback
    mkdir -p "$OUT/tools/lib"
    cp -a "$OUT/usr/lib"/* "$OUT/tools/lib/" 2>/dev/null || true
fi

echo "Checking for stubs.h:"
find "$OUT" -name "stubs*" -type f 2>/dev/null

echo "Checking for CRT files:"
ls -la "$OUT/usr/lib/crt*.o" 2>/dev/null || echo "No CRT files found"

# Create /etc/ld.so.conf for library search paths
mkdir -p "$OUT/etc/ld.so.conf.d"
cat > "$OUT/etc/ld.so.conf" << 'LDCONF'
# Library search paths
# Include lib64 for compatibility with packages that install there
/usr/lib
/lib
/usr/lib64
/lib64
include /etc/ld.so.conf.d/*.conf
LDCONF""",
    deps = [
        ":cross-gcc-aarch64-pass1",
        ":cross-binutils-aarch64",
        ":cross-linux-headers-aarch64",
    ],
    visibility = ["PUBLIC"],
)

# ── ARM64 Cross GCC Pass 2 (full compiler with C++ support) ─────────

package(
    name = "cross-gcc-aarch64-pass2",
    build_rule = "binary",
    local_only = True,
    source = "//bootstrap/stage1:gcc-src",
    version = "14.3.0",
    description = "Cross GCC pass 2 for aarch64 - full compiler with C++ support",
    homepage = "https://gcc.gnu.org/",
    license = "GPL-3.0",
    pre_configure_cmds = ['''
# Link GMP, MPFR, MPC sources
GMP_DIR=""
MPFR_DIR=""
MPC_DIR=""

IFS=':' read -ra DEPS <<< "$DEP_BASE_DIRS"
for dep_dir in "${DEPS[@]}"; do
    if [[ "$dep_dir" == *"gmp-src"* ]] && [[ -f "$dep_dir/configure.ac" ]]; then
        GMP_DIR="$dep_dir"
    elif [[ "$dep_dir" == *"mpfr-src"* ]] && [[ -f "$dep_dir/configure.ac" ]]; then
        MPFR_DIR="$dep_dir"
    elif [[ "$dep_dir" == *"mpc-src"* ]] && [[ -f "$dep_dir/configure.ac" ]]; then
        MPC_DIR="$dep_dir"
    fi
done

[[ -n "$GMP_DIR" ]] && ln -sfn "$GMP_DIR" gmp
[[ -n "$MPFR_DIR" ]] && ln -sfn "$MPFR_DIR" mpfr
[[ -n "$MPC_DIR" ]] && ln -sfn "$MPC_DIR" mpc
'''],
    install_script = """export CC="gcc -std=gnu11 -Wno-error=implicit-function-declaration"
export CFLAGS="-O2 -std=gnu11 -Wno-error=implicit-function-declaration"
export CXX="g++ -std=gnu++11"
export CXXFLAGS="-O2 -std=gnu++11"
export CC_FOR_BUILD="gcc -std=gnu11"
export CXX_FOR_BUILD="g++ -std=gnu++11"
export CFLAGS_FOR_BUILD="-O2 -std=gnu11"
export CXXFLAGS_FOR_BUILD="-O2 -std=gnu++11"
export AS_FOR_BUILD="/usr/bin/as"
export AR_FOR_BUILD="/usr/bin/ar"
export LD_FOR_BUILD="/usr/bin/ld"
export NM_FOR_BUILD="/usr/bin/nm"
export RANLIB_FOR_BUILD="/usr/bin/ranlib"

# configure
BUCKOS_TARGET="aarch64-buckos-linux-gnu"

# Setup PATH to find cross-tools
IFS=':' read -ra DEPS <<< "$DEP_BASE_DIRS"
for dep_dir in "${DEPS[@]}"; do
    if [[ -d "$dep_dir/tools/bin" ]]; then
        export PATH="$dep_dir/tools/bin:$PATH"
    fi
done

# Find cross-binutils tools - these are REQUIRED for GCC configure
CROSS_AS=$(which ${BUCKOS_TARGET}-as 2>/dev/null || true)
CROSS_LD=$(which ${BUCKOS_TARGET}-ld 2>/dev/null || true)
CROSS_AR=$(which ${BUCKOS_TARGET}-ar 2>/dev/null || true)
CROSS_NM=$(which ${BUCKOS_TARGET}-nm 2>/dev/null || true)
CROSS_RANLIB=$(which ${BUCKOS_TARGET}-ranlib 2>/dev/null || true)
CROSS_OBJCOPY=$(which ${BUCKOS_TARGET}-objcopy 2>/dev/null || true)
CROSS_OBJDUMP=$(which ${BUCKOS_TARGET}-objdump 2>/dev/null || true)
CROSS_STRIP=$(which ${BUCKOS_TARGET}-strip 2>/dev/null || true)

echo "Cross-binutils tools:"
echo "  AS=$CROSS_AS"
echo "  LD=$CROSS_LD"
echo "  AR=$CROSS_AR"
echo "  NM=$CROSS_NM"
echo "  RANLIB=$CROSS_RANLIB"

if [ -z "$CROSS_AS" ] || [ -z "$CROSS_LD" ]; then
    echo "ERROR: Could not find cross-binutils tools in PATH" >&2
    echo "PATH=$PATH" >&2
    exit 1
fi

# Find glibc and linux-headers sysroot directories
GLIBC_DIR=""
HEADERS_DIR=""
for dep_dir in "${DEPS[@]}"; do
    if [[ "$dep_dir" == *"glibc-aarch64"* ]]; then
        # glibc now installs to /usr prefix, but also copies to /tools
        if [[ -d "$dep_dir/usr/include" ]]; then
            GLIBC_DIR="$dep_dir"
        elif [[ -d "$dep_dir/tools" ]]; then
            GLIBC_DIR="$dep_dir/tools"
        fi
    fi
    if [[ "$dep_dir" == *"linux-headers-aarch64"* ]] && [[ -d "$dep_dir/tools" ]]; then
        HEADERS_DIR="$dep_dir/tools"
    fi
done

# Create a build sysroot with the expected structure
# GCC expects headers at $sysroot/$target/include and libs at $sysroot/$target/lib
BUILD_SYSROOT="$PWD/build-sysroot"
mkdir -p "$BUILD_SYSROOT/$BUCKOS_TARGET/include"
mkdir -p "$BUILD_SYSROOT/$BUCKOS_TARGET/lib"

# Copy/link glibc headers and libs
if [[ -n "$GLIBC_DIR" ]]; then
    echo "Linking glibc from $GLIBC_DIR..."
    # Try /usr/include first (new prefix), then /tools/include fallback
    if [[ -d "$GLIBC_DIR/usr/include" ]]; then
        cp -aL "$GLIBC_DIR/usr/include"/* "$BUILD_SYSROOT/$BUCKOS_TARGET/include/" 2>/dev/null || true
    fi
    if [[ -d "$GLIBC_DIR/tools/include" ]]; then
        cp -aL "$GLIBC_DIR/tools/include"/* "$BUILD_SYSROOT/$BUCKOS_TARGET/include/" 2>/dev/null || true
    fi
    if [[ -d "$GLIBC_DIR/include" ]]; then
        cp -aL "$GLIBC_DIR/include"/* "$BUILD_SYSROOT/$BUCKOS_TARGET/include/" 2>/dev/null || true
    fi
    if [[ -d "$GLIBC_DIR/tools/$BUCKOS_TARGET/include" ]]; then
        cp -aL "$GLIBC_DIR/tools/$BUCKOS_TARGET/include"/* "$BUILD_SYSROOT/$BUCKOS_TARGET/include/" 2>/dev/null || true
    fi
    # Try /usr/lib first, then /tools/lib fallback (use -L to dereference symlinks)
    if [[ -d "$GLIBC_DIR/usr/lib" ]]; then
        cp -aL "$GLIBC_DIR/usr/lib"/* "$BUILD_SYSROOT/$BUCKOS_TARGET/lib/" 2>/dev/null || true
    fi
    if [[ -d "$GLIBC_DIR/tools/lib" ]]; then
        cp -aL "$GLIBC_DIR/tools/lib"/* "$BUILD_SYSROOT/$BUCKOS_TARGET/lib/" 2>/dev/null || true
    fi
    if [[ -d "$GLIBC_DIR/lib" ]]; then
        cp -aL "$GLIBC_DIR/lib"/* "$BUILD_SYSROOT/$BUCKOS_TARGET/lib/" 2>/dev/null || true
    fi
    if [[ -d "$GLIBC_DIR/tools/$BUCKOS_TARGET/lib" ]]; then
        cp -aL "$GLIBC_DIR/tools/$BUCKOS_TARGET/lib"/* "$BUILD_SYSROOT/$BUCKOS_TARGET/lib/" 2>/dev/null || true
    fi

    # CRITICAL: Ensure the dynamic linker is a real file, not a broken symlink
    echo "Checking dynamic linker in build-sysroot..."
    if [ -L "$BUILD_SYSROOT/$BUCKOS_TARGET/lib/ld-linux-aarch64.so.1" ] && [ ! -e "$BUILD_SYSROOT/$BUCKOS_TARGET/lib/ld-linux-aarch64.so.1" ]; then
        echo "Dynamic linker is a broken symlink, fixing..."
        rm -f "$BUILD_SYSROOT/$BUCKOS_TARGET/lib/ld-linux-aarch64.so.1"
        # Copy from the actual file in glibc
        if [ -f "$GLIBC_DIR/usr/lib/ld-linux-aarch64.so.1" ]; then
            cp -v "$GLIBC_DIR/usr/lib/ld-linux-aarch64.so.1" "$BUILD_SYSROOT/$BUCKOS_TARGET/lib/"
        elif [ -f "$GLIBC_DIR/usr/lib/ld.so" ]; then
            cp -v "$GLIBC_DIR/usr/lib/ld.so" "$BUILD_SYSROOT/$BUCKOS_TARGET/lib/ld-linux-aarch64.so.1"
        fi
    fi

    # Verify the file exists and is valid
    echo "Dynamic linker check:"
    ls -la "$BUILD_SYSROOT/$BUCKOS_TARGET/lib/ld-linux-aarch64.so.1" || echo "WARNING: Dynamic linker missing!"
    file "$BUILD_SYSROOT/$BUCKOS_TARGET/lib/ld-linux-aarch64.so.1" 2>/dev/null || true
fi

# Copy/link linux headers
if [[ -n "$HEADERS_DIR" ]]; then
    echo "Linking linux headers from $HEADERS_DIR..."
    if [[ -d "$HEADERS_DIR/$BUCKOS_TARGET/include" ]]; then
        cp -a "$HEADERS_DIR/$BUCKOS_TARGET/include"/* "$BUILD_SYSROOT/$BUCKOS_TARGET/include/" 2>/dev/null || true
    fi
fi

# CRITICAL: GCC's linker also searches for CRT files and libraries at $SYSROOT/lib and $SYSROOT/usr/lib
# We need to create these paths as symlinks to the actual location $SYSROOT/$TARGET/lib
echo "Creating additional sysroot lib paths for linker..."
mkdir -p "$BUILD_SYSROOT/usr"
ln -sfn "$BUILD_SYSROOT/$BUCKOS_TARGET/lib" "$BUILD_SYSROOT/lib"
ln -sfn "$BUILD_SYSROOT/$BUCKOS_TARGET/lib" "$BUILD_SYSROOT/usr/lib"
ln -sfn "$BUILD_SYSROOT/$BUCKOS_TARGET/include" "$BUILD_SYSROOT/usr/include"

# Create stub sys/sdt.h header for libstdc++ (SystemTap support disabled but header still referenced)
echo "Creating stub sys/sdt.h header..."
mkdir -p "$BUILD_SYSROOT/$BUCKOS_TARGET/include/sys"
cat > "$BUILD_SYSROOT/$BUCKOS_TARGET/include/sys/sdt.h" << 'SDTEOF'
/* Stub sys/sdt.h for cross-compilation - SystemTap not available */
#ifndef _SYS_SDT_H
#define _SYS_SDT_H
/* No SystemTap support - empty macros */
#define STAP_PROBE(...)
#define STAP_PROBE1(...)
#define STAP_PROBE2(...)
#define STAP_PROBE3(...)
#define STAP_PROBE4(...)
#define STAP_PROBE5(...)
#define STAP_PROBE6(...)
#define STAP_PROBE7(...)
#define STAP_PROBE8(...)
#define STAP_PROBE9(...)
#define STAP_PROBE10(...)
#define DTRACE_PROBE(...)
#define DTRACE_PROBE1(...)
#define DTRACE_PROBE2(...)
#define DTRACE_PROBE3(...)
#define DTRACE_PROBE4(...)
#define DTRACE_PROBE5(...)
#define DTRACE_PROBE6(...)
#define DTRACE_PROBE7(...)
#define DTRACE_PROBE8(...)
#define DTRACE_PROBE9(...)
#define DTRACE_PROBE10(...)
#endif /* _SYS_SDT_H */
SDTEOF

echo "Build sysroot structure:"
ls -la "$BUILD_SYSROOT/"
echo "Build sysroot lib contents (CRT files):"
ls -la "$BUILD_SYSROOT/$BUCKOS_TARGET/lib/" | grep -E "^-.*\.o|^-.*\.a|^-.*\.so" | head -30

# Set _FOR_BUILD environment variables to prevent glibc 2.38+ C23 symbol usage
# These MUST be set before configure runs, as configure compiles host tools
export CC_FOR_BUILD="gcc -std=gnu11"
export CXX_FOR_BUILD="g++ -std=gnu++11"
export CFLAGS_FOR_BUILD="-O2 -std=gnu11"
export CXXFLAGS_FOR_BUILD="-O2 -std=gnu++11"
export LDFLAGS_FOR_BUILD=""

# Clean any stale config.cache files from previous builds that may have different flags
find . -name 'config.cache' -delete 2>/dev/null || true

mkdir -p build && cd build

# Also clean cache in build directory
find . -name 'config.cache' -delete 2>/dev/null || true

../configure \
    --prefix=/tools \
    --target=$BUCKOS_TARGET \
    --with-sysroot=/tools \
    --with-build-sysroot="$BUILD_SYSROOT" \
    --with-native-system-header-dir=/$BUCKOS_TARGET/include \
    --enable-initfini-array \
    --enable-shared \
    --enable-threads=posix \
    --enable-__cxa_atexit \
    --enable-clocale=gnu \
    --enable-languages=c,c++ \
    --disable-libssp \
    --disable-libgomp \
    --disable-libquadmath \
    --disable-nls \
    --disable-multilib \
    --disable-systemtap \
    --disable-libsanitizer \
    --disable-bootstrap \
    --disable-fixincludes \
    --enable-default-hash-style=gnu \
    AS_FOR_TARGET="$CROSS_AS" \
    LD_FOR_TARGET="$CROSS_LD" \
    AR_FOR_TARGET="$CROSS_AR" \
    NM_FOR_TARGET="$CROSS_NM" \
    RANLIB_FOR_TARGET="$CROSS_RANLIB" \
    OBJCOPY_FOR_TARGET="$CROSS_OBJCOPY" \
    OBJDUMP_FOR_TARGET="$CROSS_OBJDUMP" \
    STRIP_FOR_TARGET="$CROSS_STRIP" \
    CC_FOR_BUILD="gcc -std=gnu11" \
    CXX_FOR_BUILD="g++ -std=gnu++11" \
    CFLAGS_FOR_BUILD="-O2 -std=gnu11" \
    CXXFLAGS_FOR_BUILD="-O2 -std=gnu++11" \
    MAKEINFO=true

# build
# Pass _FOR_BUILD variables to make to ensure host tools use -std=gnu11
# This prevents __isoc23_* symbol usage from glibc 2.38+
make -j$MAKE_JOBS MAKEINFO=true \
    CC_FOR_BUILD="gcc -std=gnu11" \
    CXX_FOR_BUILD="g++ -std=gnu++11" \
    CFLAGS_FOR_BUILD="-O2 -std=gnu11" \
    CXXFLAGS_FOR_BUILD="-O2 -std=gnu++11" \
    BOOT_CFLAGS="-O2 -std=gnu11" \
    BOOT_CXXFLAGS="-O2 -std=gnu++11" \
    BUILD_CFLAGS="-O2 -std=gnu11" \
    BUILD_CXXFLAGS="-O2 -std=gnu++11"

# install
make -j$MAKE_JOBS DESTDIR="$OUT" install MAKEINFO=true""",
    deps = [
        "//bootstrap/stage1:gmp-src",
        "//bootstrap/stage1:mpfr-src",
        "//bootstrap/stage1:mpc-src",
        ":cross-binutils-aarch64",
        ":cross-glibc-aarch64",
        ":cross-linux-headers-aarch64",
    ],
    visibility = ["PUBLIC"],
)

# ── Complete ARM64 cross-toolchain ───────────────────────────────────

filegroup(
    name = "cross-toolchain-aarch64",
    srcs = [
        ":cross-binutils-aarch64",
        ":cross-gcc-aarch64-pass2",
        ":cross-glibc-aarch64",
        ":cross-linux-headers-aarch64",
    ],
    visibility = ["PUBLIC"],
)
