"""
Bootstrap toolchain instantiation and export.

Gentoo-style staged bootstrap:

  Stage 1  — cross-compiler (host GCC → buckos cross-compiler)
  Stage 2  — temporary tools (cross-compiled, host PATH leaks in)
  Stage 3  — hermetic rebuild (rebuilt with stage 2 tools on PATH)

Provides:
  :bootstrap-toolchain  — BuildToolchainInfo wrapping Stage 1 output
  :stage2-toolchain     — Stage 1 cross-compiler (PATH from per-rule deps)
  :seed-export          — distributable tar.zst (cross-compiler +
                          stage 3 buckos-native host tools)
"""

load("//tc:toolchain_rules.bzl", "buckos_bootstrap_toolchain")
load("//tc:transitions.bzl", "default_dep")
load("//defs/rules:toolchain_export.bzl", "toolchain_export")

buckos_bootstrap_toolchain(
    name = "bootstrap-toolchain",
    bootstrap_stage = "//tc/bootstrap/stage1:stage1",
    visibility = ["PUBLIC"],
)

# Stage 2 host tools resolved in DEFAULT config via default_dep wrapper.
# No longer a stage2-toolchain dep (PATH now comes from per-rule host
# tool exec_deps), but kept for seed-export bundling and direct use.
default_dep(
    name = "stage2-host-tools",
    dep = "//tc/bootstrap/host-tools:host-tools",
    visibility = ["PUBLIC"],
)

# Stage 2 toolchain: stage 1 cross-compiler, no host_tools.
# PATH is assembled from per-rule host tool exec_deps via --hermetic-empty
# + --path-prepend instead of a single host_bin_dir.  This removes the
# tight coupling between the toolchain and the host_tools_aggregator
# mega target, which now only exists for seed-export bundling.
buckos_bootstrap_toolchain(
    name = "stage2-toolchain",
    bootstrap_stage = "//tc/bootstrap/stage1:stage1",
    extra_cflags = ["-march=x86-64-v3"],
    visibility = ["PUBLIC"],
)

# Seed export: stage 1 cross-compiler + stage 3 hermetic host tools.
# The stage3 transition (on host_tools attr) rebuilds host-tools with
# the stage 2 toolchain, ensuring no host PATH leakage in the output.
toolchain_export(
    name = "seed-export",
    stage = "//tc/bootstrap/stage1:stage1",
    host_tools = "//tc/bootstrap/host-tools:host-tools",
    gcc_version = "14.3.0",
    glibc_version = "2.42",
    visibility = ["PUBLIC"],
)
