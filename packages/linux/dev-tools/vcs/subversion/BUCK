load("//defs:package.bzl", "package")

package(
    build_rule = "autotools",
    name = "subversion",
    version = "1.14.3",
    url = "https://archive.apache.org/dist/subversion/subversion-1.14.3.tar.bz2",
    sha256 = "949efd451a09435f7e8573574c71c7b71b194d844890fa49cd61d2262ea1a440",
    description = "Enterprise-class centralized version control for the masses",
    homepage = "https://subversion.apache.org/",
    license = "Apache-2.0",

    # USE flags this package supports

    # Default USE flags

    # Conditional dependencies
    use_deps = {
        "perl": "//packages/linux/lang/perl:perl",
        "python": "//packages/linux/lang/python:python",
        "ruby": "//packages/linux/lang/ruby:ruby",
    },

    # Conditional configure arguments
    use_configure = {
        "apache2": ("--enable-apache2", "--disable-apache2"),
        "berkdb": ("--enable-berkdb", "--disable-berkdb"),
        "debug": ("--enable-debug", "--disable-debug"),
        "extras": ("--enable-extras", "--disable-extras"),
        "java": ("--enable-java", "--disable-java"),
        "keyring": ("--enable-keyring", "--disable-keyring"),
        "kwallet": ("--enable-kwallet", "--disable-kwallet"),
        "nls": ("--enable-nls", "--disable-nls"),
        "perl": ("--with-swig=/usr/bin/swig", "--without-swig"),
        "plaintext-password-storage": ("--enable-plaintext-password-storage", "--disable-plaintext-password-storage"),
        "python": ("--enable-python-bindings", "--disable-python-bindings"),
        "ruby": ("--enable-ruby-bindings", "--disable-ruby-bindings"),
        "sasl": ("--enable-sasl", "--disable-sasl"),
        "static-libs": ("--enable-static", "--disable-static"),
    },

    # Custom configure to find APR correctly
    src_configure = """
# Find apr-1-config in PATH (set by build system from deps)
APR_CONFIG=$(which apr-1-config 2>/dev/null || true)
APU_CONFIG=$(which apu-1-config 2>/dev/null || true)

if [ -z "$APR_CONFIG" ] || [ ! -x "$APR_CONFIG" ]; then
    echo "Error: apr-1-config not found in PATH"
    echo "PATH: $PATH"
    exit 1
fi

if [ -z "$APU_CONFIG" ] || [ ! -x "$APU_CONFIG" ]; then
    echo "Warning: apu-1-config not found, will use apr-util from apr location"
fi

APR_DIR=$(dirname $(dirname "$APR_CONFIG"))
echo "Found APR at: $APR_DIR (config: $APR_CONFIG)"

./configure --prefix=/usr \\
    --with-apr="$APR_CONFIG" \\
    --with-apr-util="${APU_CONFIG:-$APR_DIR}" \\
    --with-zlib=/usr \\
    --disable-static
""",
    configure_args = [],

    deps = [
        "//packages/linux/core/zlib:zlib",
        "//packages/linux/system/libs/crypto/openssl:openssl",
        "//packages/linux/dev-libs/misc/apr:apr",
        "//packages/linux/dev-libs/misc/apr-util:apr-util",
    ],
    visibility = ["PUBLIC"],
)
