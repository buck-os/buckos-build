load("//defs:package.bzl", "package")

# ClickHouse - Fast open-source column-oriented database management system
#
# ClickHouse is an open-source column-oriented DBMS for online analytical
# processing (OLAP). It allows generating analytical reports using SQL
# queries in real-time, processing billions of rows per second.
#
# USE flags:
#   mysql     - Enable MySQL protocol compatibility
#   postgres  - Enable PostgreSQL protocol compatibility
#   kafka     - Enable Kafka integration
#   s3        - Enable S3 storage support
#   hdfs      - Enable HDFS storage support
#   ssl       - Enable SSL/TLS support
#   odbc      - Enable ODBC support
#   parquet   - Enable Parquet format support
#   avro      - Enable Avro format support
#   grpc      - Enable gRPC support
#   embedded  - Build embedded server library

package(
    build_rule = "cmake",
    name = "clickhouse",
    version = "26.1.3.52",
    url = "https://github.com/ClickHouse/ClickHouse/archive/refs/tags/v26.1.3.52-stable.tar.gz",
    sha256 = "655383b3351cd6db786f570069521cc5b01e157d82d7ffd71c27c33f531f5949",
    description = "Fast open-source column-oriented OLAP database",
    homepage = "https://clickhouse.com/",
    license = "Apache-2.0",
    configure_args = [
        "-DCMAKE_BUILD_TYPE=Release",
        "-DENABLE_TESTING=OFF",
        "-DENABLE_TESTS=OFF",
        "-DENABLE_EXAMPLES=OFF",
        "-DUSE_STATIC_LIBRARIES=OFF",
        "-DSPLIT_SHARED_LIBRARIES=ON",
        "-DCLICKHOUSE_SPLIT_BINARY=ON",
        # Use system libraries where available
        "-DUSE_INTERNAL_ZLIB_LIBRARY=OFF",
        "-DUSE_INTERNAL_LZ4_LIBRARY=OFF",
        "-DUSE_INTERNAL_ZSTD_LIBRARY=OFF",
    ],
    use_configure = {
        "mysql": ("-DENABLE_MYSQL=ON", "-DENABLE_MYSQL=OFF"),
        "postgres": ("-DENABLE_POSTGRESQL=ON", "-DENABLE_POSTGRESQL=OFF"),
        "kafka": ("-DENABLE_KAFKA=ON", "-DENABLE_KAFKA=OFF"),
        "s3": ("-DENABLE_S3=ON", "-DENABLE_S3=OFF"),
        "hdfs": ("-DENABLE_HDFS=ON", "-DENABLE_HDFS=OFF"),
        "ssl": ("-DENABLE_SSL=ON", "-DENABLE_SSL=OFF"),
        "odbc": ("-DENABLE_ODBC=ON", "-DENABLE_ODBC=OFF"),
        "parquet": ("-DENABLE_PARQUET=ON", "-DENABLE_PARQUET=OFF"),
        "avro": ("-DENABLE_AVRO=ON", "-DENABLE_AVRO=OFF"),
        "grpc": ("-DENABLE_GRPC=ON", "-DENABLE_GRPC=OFF"),
        "embedded": ("-DENABLE_EMBEDDED_COMPILER=ON", "-DENABLE_EMBEDDED_COMPILER=OFF"),
    },
    deps = [
        "//packages/linux/core/zlib:zlib",
        "//packages/linux/system/libs/compression/lz4:lz4",
        "//packages/linux/system/libs/compression/zstd:zstd",
    ],
    post_install_cmds = ["""
#!/bin/bash
set -e

# Create default configuration directory
mkdir -p "$DESTDIR/etc/clickhouse-server"
mkdir -p "$DESTDIR/etc/clickhouse-client"

# Create data and log directories (will be created at runtime)
mkdir -p "$DESTDIR/var/lib/clickhouse"
mkdir -p "$DESTDIR/var/log/clickhouse-server"

# Create systemd service file
mkdir -p "$DESTDIR/usr/lib/systemd/system"
cat > "$DESTDIR/usr/lib/systemd/system/clickhouse-server.service" << 'EOF'
[Unit]
Description=ClickHouse Server
After=network.target

[Service]
Type=notify
User=clickhouse
Group=clickhouse
ExecStart=/usr/bin/clickhouse-server --config=/etc/clickhouse-server/config.xml
Restart=on-failure
LimitNOFILE=500000
CapabilityBoundingSet=CAP_NET_ADMIN CAP_IPC_LOCK CAP_SYS_NICE

[Install]
WantedBy=multi-user.target
EOF

# Create user setup script
mkdir -p "$DESTDIR/usr/lib/sysusers.d"
cat > "$DESTDIR/usr/lib/sysusers.d/clickhouse.conf" << 'EOF'
u clickhouse - "ClickHouse Server" /var/lib/clickhouse
EOF

# Create tmpfiles configuration
mkdir -p "$DESTDIR/usr/lib/tmpfiles.d"
cat > "$DESTDIR/usr/lib/tmpfiles.d/clickhouse.conf" << 'EOF'
d /var/lib/clickhouse 0750 clickhouse clickhouse -
d /var/log/clickhouse-server 0750 clickhouse clickhouse -
EOF
    """],
    visibility = ["PUBLIC"],
)
