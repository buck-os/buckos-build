# IMA enforcement QEMU test fixtures
#
# Builds a minimal kernel with IMA support + embedded test cert,
# plus static test binaries. Used by tests/test_ima_qemu.py.

# Static test binary — prints "IMA-TEST-PASS" and exits 0
genrule(
    name = "ima-test-binary",
    srcs = ["ima-test.c"],
    cmd = "cc -static -o $OUT $SRCS",
    out = "ima-test",
    visibility = ["PUBLIC"],
)

# Static PID-1 init for QEMU — mounts, loads IMA policy, execs test, reports
genrule(
    name = "ima-init",
    srcs = ["init.c"],
    cmd = "cc -static -o $OUT $SRCS",
    out = "init",
    visibility = ["PUBLIC"],
)

# Minimal kernel with IMA enforcement + test cert embedded in trusted keyring
#
# Uses tinyconfig as base, merges our IMA fragment, embeds the test cert
# so CONFIG_SYSTEM_TRUSTED_KEYS and CONFIG_IMA_LOAD_X509 work together.
genrule(
    name = "ima-kernel",
    srcs = ["ima-test-kernel.config"],
    cmd = """\
set -e

# Save paths before cd (SRCS/OUT are relative to genrule working dir)
ORIG_DIR="$PWD"
BUILD="$TMPDIR/kbuild"
mkdir -p "$BUILD"

# Copy kernel source to writable build dir
cp -a $(location //packages/linux/kernel/src:linux-lts-src)/. "$BUILD/"

# Embed IMA test cert for CONFIG_SYSTEM_TRUSTED_KEYS
mkdir -p "$BUILD/certs"
cp $(location //defs/keys:ima-test-cert) "$BUILD/certs/signing_key.pem"

cd "$BUILD"

# Check for GCC 14+ (C23 breaks kernel bool/true/false)
GCC_MAJOR=`gcc --version | grep -oE '[0-9]+\\.[0-9]+' | head -1 | cut -d. -f1`
MAKE_CC=""
if [ -n "$GCC_MAJOR" ] && [ "$GCC_MAJOR" -ge 14 ] 2>/dev/null; then
    mkdir -p .cc-wrapper
    printf '#!/bin/bash\\nexec /usr/bin/gcc "$@" -std=gnu11\\n' > .cc-wrapper/gcc
    chmod +x .cc-wrapper/gcc
    MAKE_CC="CC=$BUILD/.cc-wrapper/gcc HOSTCC=$BUILD/.cc-wrapper/gcc"
fi

# tinyconfig base + our IMA fragment
make -s $MAKE_CC tinyconfig
scripts/kconfig/merge_config.sh -m .config "$ORIG_DIR/$SRCS"
make -s $MAKE_CC olddefconfig

# Build
make $MAKE_CC -j`nproc` -s bzImage

cp arch/x86/boot/bzImage "$ORIG_DIR/$OUT"
""",
    out = "vmlinuz",
    visibility = ["PUBLIC"],
)
